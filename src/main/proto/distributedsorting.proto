syntax = "proto3";

package distributedsorting;

// =========================================================
// 1. 공통 데이터 타입 (Key)
// =========================================================

// Key 타입: 10바이트 Array[Byte]를 표현
// bytes 타입은 가변 길이지만, 프로젝트에서는 10바이트로 사용됨.
message KeyMessage {
    bytes value = 1;
}

// =========================================================
// 2. 워커 -> 마스터 메시지
// =========================================================

// 데이터 수 통보를 위한 메시지
message RecordCountReport {
    string worker_id = 1;      // 워커 ID (등록된 워커임을 확인)
    int64 total_record_count = 2; // 워커가 가진 총 레코드 수 (n_i)
}

// 워커가 마스터에게 샘플링된 Key 리스트를 보낼 때 사용
message SampleKeyList {
    string worker_id = 1;
    repeated KeyMessage keys = 2;     // 샘플링된 Key들의 리스트
}

// =========================================================
// 3. 마스터 -> 워커 메시지
// =========================================================

// 마스터가 워커에게 샘플링 비율을 보낼 때 사용
message SamplingRatio {
    double ratio = 1;          // 샘플링 확률 (k/n)
}

// 마스터가 워커에게 최종 파티션 정보와 순서를 보낼 때 사용
message PartitionInfo {
    // 마스터가 결정한 파티션 경계 Key 리스트 (W-1개)
    repeated KeyMessage pivots = 1; 
}

message SampleDecision {
    bool proceed = 1;                 // true: PartitionInfo를 사용 / false: 재샘플링 필요
    oneof content {
        PartitionInfo partition_info = 2; // proceed가 true일 때
        SamplingControl control = 3;      // proceed가 false일 때
    }
}
message SamplingControl {
    double new_ratio = 1;             // 재샘플링을 위한 새로운 확률 (Optional)
}

// =========================================================
// 4. 마스터 서비스 정의 (gRPC)
// =========================================================

service MasterService {
    // 샘플링 비율 결정 단계
    // 등록된 워커가 자신의 레코드 수를 보고하고, 마스터는 샘플링 비율을 응답
    rpc ReportRecordCount (RecordCountReport) returns (SamplingRatio);
    
    // 최종 파티션 경계 결정 단계
    // 워커가 샘플 Key 리스트를 보고하고, 마스터는 최종 피벗 정보를 응답
    rpc SendSampleKeys (SampleKeyList) returns (SampleDecision);
}

// =========================================================
// 5. Shuffle Phase 워커 간 통신
// =========================================================

// 중간 파일 요청 메시지
message IntermediateFileRequest{
    int32 i = 1; // i'th node (파일을 생성한 워커 ID)
    int32 j = 2; // j'th partition (대상 워커 ID, 요청하는 워커)
    int32 k = 3; // k'th index file (같은 i→j에 대한 k번째 파일)
}

// 중간 파일 응답 메시지
message IntermediateFileResponse {
    // FIXME: 파일데이터가 4MB이상일때 작동하지않음.
    bytes data = 1;        // 파일 데이터 
    bool success = 2;      // 성공 여부
    string error_msg = 3;  // 에러 메시지 (실패 시)
}

// 워커 간 파일 교환을 위한 서비스
service WorkerService {
    // 다른 워커로부터 중간 파일을 요청
    // Shuffle phase에서 워커가 필요한 파일(file_i_j_k)을 다른 워커로부터 가져올 때 사용
    rpc GetIntermediateFile (IntermediateFileRequest) returns (IntermediateFileResponse);
}